{
  "name": "AI Virtual Classroom - Five Teacher Workflow",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "chat-webhook",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300],
      "webhookId": "chat-webhook"
    },
    {
      "parameters": {
        "jsCode": "// Simple round-robin teacher selection (no Redis needed)\nconst teachers = ['teacher_a', 'teacher_b', 'teacher_c', 'teacher_d', 'teacher_e'];\nconst lastTeacher = $input.item.json.lastTeacher || 'teacher_e';\nconst currentIndex = teachers.indexOf(lastTeacher);\nconst nextIndex = (currentIndex + 1) % teachers.length;\nconst selectedTeacher = teachers[nextIndex];\n\n// Extract message from webhook body - try multiple locations\nlet message = '';\nconst inputData = $input.item.json;\n\n// Try different ways to get the message\nif (inputData.body) {\n  // Body might be an object or string\n  if (typeof inputData.body === 'object') {\n    message = inputData.body.message || '';\n  } else if (typeof inputData.body === 'string') {\n    try {\n      const parsed = JSON.parse(inputData.body);\n      message = parsed.message || '';\n    } catch (e) {\n      message = inputData.body;\n    }\n  }\n}\n\n// Try direct message field\nif (!message && inputData.message) {\n  message = inputData.message;\n}\n\n// Try query parameters\nif (!message && inputData.query && inputData.query.message) {\n  message = inputData.query.message;\n}\n\n// Fallback: use body as-is if it's a string\nif (!message && inputData.body && typeof inputData.body === 'string') {\n  message = inputData.body;\n}\n\n// If still no message, use a default\nif (!message) {\n  message = 'Hello, how can I help you?';\n}\n\nreturn {\n  json: {\n    selectedTeacher: selectedTeacher,\n    lastTeacher: selectedTeacher,\n    message: message\n  }\n};"
      },
      "id": "select-teacher",
      "name": "Select Teacher (Round-Robin)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "url": "http://localhost:11434/api/generate",
        "method": "POST",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "model",
              "value": "mistral:7b"
            },
            {
              "name": "prompt",
              "value": "=You are Maya, a warm and approachable educator. Keep responses concise (2-3 sentences) and conversational. User message: {{ $json.message }}"
            },
            {
              "name": "stream",
              "value": "false"
            }
          ]
        },
        "options": {}
      },
      "id": "llm-teacher-a",
      "name": "LLM Generate - Teacher A",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [650, 100]
    },
    {
      "parameters": {
        "url": "http://localhost:11434/api/generate",
        "method": "POST",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "model",
              "value": "mistral:7b"
            },
            {
              "name": "prompt",
              "value": "=You are Maximus, a technical expert. Keep responses concise (2-3 sentences) and informative. User message: {{ $json.message }}"
            },
            {
              "name": "stream",
              "value": "false"
            }
          ]
        },
        "options": {}
      },
      "id": "llm-teacher-b",
      "name": "LLM Generate - Teacher B",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [650, 200]
    },
    {
      "parameters": {
        "url": "http://localhost:11434/api/generate",
        "method": "POST",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "model",
              "value": "mistral:7b"
            },
            {
              "name": "prompt",
              "value": "=You are Krishna, an enthusiastic educator. Keep responses concise (2-3 sentences) and engaging. User message: {{ $json.message }}"
            },
            {
              "name": "stream",
              "value": "false"
            }
          ]
        },
        "options": {}
      },
      "id": "llm-teacher-c",
      "name": "LLM Generate - Teacher C",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [650, 300]
    },
    {
      "parameters": {
        "url": "http://localhost:11434/api/generate",
        "method": "POST",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "model",
              "value": "mistral:7b"
            },
            {
              "name": "prompt",
              "value": "=You are TechMonkey Steve, an innovative educator. Keep responses concise (2-3 sentences) and engaging. User message: {{ $json.message }}"
            },
            {
              "name": "stream",
              "value": "false"
            }
          ]
        },
        "options": {}
      },
      "id": "llm-teacher-d",
      "name": "LLM Generate - Teacher D",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [650, 400]
    },
    {
      "parameters": {
        "url": "http://localhost:11434/api/generate",
        "method": "POST",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "model",
              "value": "mistral:7b"
            },
            {
              "name": "prompt",
              "value": "=You are Pano Bieber, a knowledgeable educator. Keep responses concise (2-3 sentences) and helpful. User message: {{ $json.message }}"
            },
            {
              "name": "stream",
              "value": "false"
            }
          ]
        },
        "options": {}
      },
      "id": "llm-teacher-e",
      "name": "LLM Generate - Teacher E",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [650, 500]
    },
    {
      "parameters": {
        "jsCode": "// Add teacher identifier to each LLM response\nconst llmResponse = $input.item.json;\nlet responseText = '';\n\nif (llmResponse.response) {\n  responseText = llmResponse.response;\n} else if (typeof llmResponse === 'string') {\n  responseText = llmResponse;\n} else if (llmResponse.text) {\n  responseText = llmResponse.text;\n}\n\n// Determine which teacher this is based on node name\nconst nodeName = $node.name;\nlet teacherId = 'teacher_a';\nif (nodeName.includes('Teacher B')) teacherId = 'teacher_b';\nelse if (nodeName.includes('Teacher C')) teacherId = 'teacher_c';\nelse if (nodeName.includes('Teacher D')) teacherId = 'teacher_d';\nelse if (nodeName.includes('Teacher E')) teacherId = 'teacher_e';\n\nreturn {\n  json: {\n    text: responseText || 'Hello! I am ready to help.',\n    teacher: teacherId,\n    message: $('Select Teacher (Round-Robin)').item.json.message,\n    selectedTeacher: $('Select Teacher (Round-Robin)').item.json.selectedTeacher\n  }\n};"
      },
      "id": "extract-teacher-a",
      "name": "Extract Response - Teacher A",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [850, 100]
    },
    {
      "parameters": {
        "jsCode": "// Add teacher identifier to each LLM response\nconst llmResponse = $input.item.json;\nlet responseText = '';\n\nif (llmResponse.response) {\n  responseText = llmResponse.response;\n} else if (typeof llmResponse === 'string') {\n  responseText = llmResponse;\n} else if (llmResponse.text) {\n  responseText = llmResponse.text;\n}\n\nreturn {\n  json: {\n    text: responseText || 'Hello! I am ready to help.',\n    teacher: 'teacher_b',\n    message: $('Select Teacher (Round-Robin)').item.json.message,\n    selectedTeacher: $('Select Teacher (Round-Robin)').item.json.selectedTeacher\n  }\n};"
      },
      "id": "extract-teacher-b",
      "name": "Extract Response - Teacher B",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [850, 200]
    },
    {
      "parameters": {
        "jsCode": "// Add teacher identifier to each LLM response\nconst llmResponse = $input.item.json;\nlet responseText = '';\n\nif (llmResponse.response) {\n  responseText = llmResponse.response;\n} else if (typeof llmResponse === 'string') {\n  responseText = llmResponse;\n} else if (llmResponse.text) {\n  responseText = llmResponse.text;\n}\n\nreturn {\n  json: {\n    text: responseText || 'Hello! I am ready to help.',\n    teacher: 'teacher_c',\n    message: $('Select Teacher (Round-Robin)').item.json.message,\n    selectedTeacher: $('Select Teacher (Round-Robin)').item.json.selectedTeacher\n  }\n};"
      },
      "id": "extract-teacher-c",
      "name": "Extract Response - Teacher C",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [850, 300]
    },
    {
      "parameters": {
        "jsCode": "// Add teacher identifier to each LLM response\nconst llmResponse = $input.item.json;\nlet responseText = '';\n\nif (llmResponse.response) {\n  responseText = llmResponse.response;\n} else if (typeof llmResponse === 'string') {\n  responseText = llmResponse;\n} else if (llmResponse.text) {\n  responseText = llmResponse.text;\n}\n\nreturn {\n  json: {\n    text: responseText || 'Hello! I am ready to help.',\n    teacher: 'teacher_d',\n    message: $('Select Teacher (Round-Robin)').item.json.message,\n    selectedTeacher: $('Select Teacher (Round-Robin)').item.json.selectedTeacher\n  }\n};"
      },
      "id": "extract-teacher-d",
      "name": "Extract Response - Teacher D",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [850, 400]
    },
    {
      "parameters": {
        "jsCode": "// Add teacher identifier to each LLM response\nconst llmResponse = $input.item.json;\nlet responseText = '';\n\nif (llmResponse.response) {\n  responseText = llmResponse.response;\n} else if (typeof llmResponse === 'string') {\n  responseText = llmResponse;\n} else if (llmResponse.text) {\n  responseText = llmResponse.text;\n}\n\nreturn {\n  json: {\n    text: responseText || 'Hello! I am ready to help.',\n    teacher: 'teacher_e',\n    message: $('Select Teacher (Round-Robin)').item.json.message,\n    selectedTeacher: $('Select Teacher (Round-Robin)').item.json.selectedTeacher\n  }\n};"
      },
      "id": "extract-teacher-e",
      "name": "Extract Response - Teacher E",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [850, 500]
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByIndex",
        "options": {}
      },
      "id": "merge-responses",
      "name": "Merge All Responses",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "jsCode": "// Select the response from the teacher that was selected by round-robin\nconst allResponses = $input.all();\nconst selectedTeacher = $('Select Teacher (Round-Robin)').item.json.selectedTeacher;\n\n// Find the response from the selected teacher\nconst selectedResponse = allResponses.find(item => item.json.teacher === selectedTeacher);\n\nif (selectedResponse) {\n  return selectedResponse.json;\n} else {\n  // Fallback to first response if selected teacher not found\n  return allResponses[0].json;\n}\n"
      },
      "id": "select-response",
      "name": "Select Response by Teacher",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 300]
    },
    {
      "parameters": {
        "url": "http://localhost:8001/tts",
        "method": "POST",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "text",
              "value": "={{ $json.text }}"
            },
            {
              "name": "voice",
              "value": "en_US-lessac-medium"
            }
          ]
        },
        "options": {}
      },
      "id": "tts-generate",
      "name": "TTS Generate",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1450, 300]
    },
    {
      "parameters": {
        "jsCode": "// Get audio URL from TTS response\nconst ttsResponse = $input.item.json;\nconst selectedTeacher = $('Select Teacher (Round-Robin)').item.json.selectedTeacher;\n\nlet audioUrl = '';\n\nif (ttsResponse.audio_url) {\n  audioUrl = ttsResponse.audio_url;\n} else if (ttsResponse.url) {\n  audioUrl = ttsResponse.url;\n}\n\nreturn {\n  json: {\n    audio_url: audioUrl,\n    avatar_id: selectedTeacher,\n    text: $('Select Response by Teacher').item.json.text\n  }\n};"
      },
      "id": "prepare-animation",
      "name": "Prepare Animation",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1650, 300]
    },
    {
      "parameters": {
        "url": "http://localhost:8002/animate",
        "method": "POST",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "audio_url",
              "value": "={{ $json.audio_url }}"
            },
            {
              "name": "avatar_id",
              "value": "={{ $json.avatar_id }}"
            }
          ]
        },
        "options": {}
      },
      "id": "animation-generate",
      "name": "Animation Generate",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1850, 300]
    },
    {
      "parameters": {
        "jsCode": "// Format response for frontend\nconst animationResponse = $input.item.json;\nconst text = $('Select Response by Teacher').item.json.text;\nconst teacher = $('Select Teacher (Round-Robin)').item.json.selectedTeacher;\n\nreturn {\n  json: {\n    response: text,\n    teacher: teacher,\n    video_url: animationResponse.video_url || animationResponse.video_path || '',\n    job_id: animationResponse.job_id || ''\n  }\n};"
      },
      "id": "format-response",
      "name": "Format Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2050, 300]
    },
    {
      "parameters": {
        "responseMode": "lastNode",
        "responseData": "allFields",
        "options": {}
      },
      "id": "respond-to-webhook",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2250, 300]
    }
  ],
  "connections": {
    "Webhook Trigger": {
      "main": [
        [
          {
            "node": "Select Teacher (Round-Robin)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Select Teacher (Round-Robin)": {
      "main": [
        [
          {
            "node": "LLM Generate - Teacher A",
            "type": "main",
            "index": 0
          },
          {
            "node": "LLM Generate - Teacher B",
            "type": "main",
            "index": 0
          },
          {
            "node": "LLM Generate - Teacher C",
            "type": "main",
            "index": 0
          },
          {
            "node": "LLM Generate - Teacher D",
            "type": "main",
            "index": 0
          },
          {
            "node": "LLM Generate - Teacher E",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LLM Generate - Teacher A": {
      "main": [
        [
          {
            "node": "Extract Response - Teacher A",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LLM Generate - Teacher B": {
      "main": [
        [
          {
            "node": "Extract Response - Teacher B",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LLM Generate - Teacher C": {
      "main": [
        [
          {
            "node": "Extract Response - Teacher C",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LLM Generate - Teacher D": {
      "main": [
        [
          {
            "node": "Extract Response - Teacher D",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LLM Generate - Teacher E": {
      "main": [
        [
          {
            "node": "Extract Response - Teacher E",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Response - Teacher A": {
      "main": [
        [
          {
            "node": "Merge All Responses",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Response - Teacher B": {
      "main": [
        [
          {
            "node": "Merge All Responses",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Response - Teacher C": {
      "main": [
        [
          {
            "node": "Merge All Responses",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Response - Teacher D": {
      "main": [
        [
          {
            "node": "Merge All Responses",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Response - Teacher E": {
      "main": [
        [
          {
            "node": "Merge All Responses",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge All Responses": {
      "main": [
        [
          {
            "node": "Select Response by Teacher",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Select Response by Teacher": {
      "main": [
        [
          {
            "node": "TTS Generate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "TTS Generate": {
      "main": [
        [
          {
            "node": "Prepare Animation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Animation": {
      "main": [
        [
          {
            "node": "Animation Generate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Animation Generate": {
      "main": [
        [
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Response": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": {},
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2026-01-22T00:00:00.000Z",
  "versionId": "1"
}
